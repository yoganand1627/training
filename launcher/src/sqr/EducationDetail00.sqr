!---------------------------------------------------------------------------------------------------------
! Generated on Fri Jun 03 15:53:25 2011 by Hyperion SQR Developer 8.5.0.0.0.302
! Filename: C:\Documents and Settings\tabailey\My Documents\Shines Reports\Reports 2011\EducationDetail00.sqr
! Format  : Tabular
! Username: TBAILEY
!---------------------------------------------------------------------------------------------------------

Begin-Setup
 Declare-Layout Default
  Orientation = Landscape
  Paper-Size = (Letter)
  Top-Margin    = 0.500 
  Bottom-Margin = 0.500 
  Left-Margin   = 0.500 
  Right-Margin  = 0.500 
  Line-Height = 1
  Char-Width  = 1
 End-Declare
 Declare-Procedure
  Before-Report = BRB_Report_Before
  After-Report = BRB_Report_After
  After-Page = BRB_After_Page
 End-Declare
DECLARE-VARIABLE
 Text $DateFrom 
END-DECLARE
End-Setup

Begin-Procedure BRB_Report_Before
 Alter-Report Heading-Size=192    ! combined report header - page header data
 Next-Listing
End-Procedure

Begin-Procedure BRB_Report_After
 Alter-Report Heading=None Footing=None
 New-Page
 Position (1,1)
 Alter-Printer Font=4 Point-Size=10    ! [SQR.INI] 4=Arial,proportional
 Print 'Definitions' (11,1,0) Underline  Bold 
 Page-Number (482,654) '' ' of '
 Last-Page (482,691) 
 Print 'Report lists all children ages 5-17 in Ongoing (ONG) stages with stage has been opened for 30 days or more and/or all children ages 5-20  in Foster Care Family (FCF) stages, who have been in care for 30 days or more after their 5th birthday, who are without an Education Detail page or whose Education Detail page has not been updated in the past 12 months.' (27,2,152) Wrap 152 3 line-height=12 Keep-Top on= 
 Print 'Report runs for optional Stage Type, Region, County, Unit, and Case Manager parameters. ' (66,2,0)
 Print 'Region and County are the region and county of the stage. ' (98,2,0)
 Print 'The case manager is the Primary (PR) case manager on the stage.' (82,2,0)
 Print 'The totals display the total number of children whose Education Detail record is not updated for the past 12 months or who do not have an Education Detail record.' (116,2,170) Wrap 170 3 line-height=12 Keep-Top
 Alter-Printer Font=4 Point-Size=8    ! [SQR.INI] 4=Arial,proportional
 Print 'Education Type' (418,10,0) Underline  Bold 
 Print 'SCH - School' (430,12,0)
 Print 'DCR - Day Care' (445,12,0)
 Print 'HST - Head Start' (459,12,0)
 Print 'HMS - Home School' (474,12,0)
 Print 'NIS - Not In School' (488,12,0)
 Print 'Education Programs' (417,126,0) Underline  Bold 
 Print 'REG - Regular Classes' (430,127,0)
 Print 'SPE - Special Education' (442,127,0)
 Print 'VOC - Vocational' (454,127,0)
 Print 'COL - College' (466,127,0)
 Print 'TCL - Technical College' (478,127,0)
 Print 'XXX - Alternative' (478,235,0)
 Print 'LDR - Learning Disorders' (430,236,0)
 Print 'BDR - Behavioral Disorders' (442,236,0)
 Print 'PED - Psycho-Educational' (454,236,0)
 Print 'PTI - Part Time' (466,236,0)
 Alter-Printer Font=4 Point-Size=10    ! [SQR.INI] 4=Arial,proportional
 Print 'Date Stage Opened:' (173,5,0) Bold 
 Print 'DOB:' (190,5,0) Bold 
 Print 'Age:' (206,5,0) Bold 
 Print 'The date the ongoing or foster care or adoption stage opened. ' (173,107,0)
 Print 'Date of birth of the primary child.' (190,51,0)
 Print 'Age of the primary child.' (206,51,0)
 Print 'Name of the school in which the child is currently enrolled.' (223,51,0)
 Print 'School:' (223,5,0) Bold 
 Print 'Curr/Enrll Grade:' (239,5,0) Bold 
 Print 'Current or Enrolled grade of the primary child. If current grade is not documented, then the enrolled grade will be displayed. If both are not documented, the field displays blank.' (239,92,121) Wrap 121 2 line-height=12 Keep-Top
 Print 'Edu Type:' (266,5,0) Bold 
 Print 'The type of educational setting in which the child is attending.' (267,60,0)
 Print 'Edu Programs:' (283,5,0) Bold 
 Print 'A list of educational programs of which the child is a part.' (282,84,0)
 Print 'Dt EduDtl Last Updated:' (299,5,0) Bold 
 Print 'Date on which the Education Detail page was last updated.' (299,125,0)
 Print 'IEP:' (316,5,0) Bold 
 Print 'Indicates whether the primary child has an Individualized Education Plan.' (315,56,0)
 Print 'HS GED:' (332,6,0) Bold 
 Print 'Indicates whether the primary child is in a high school GED program.' (332,56,0)
 Print 'Post Sec:' (349,5,0) Bold 
 Print 'Indicates whether the primary child is attending post-secondary education.' (349,56,0)
 Print 'Child Name:' (142,5,0) Bold 
 Print 'Name of the primary child.' (141,68,0)
 Print 'Case ID: ' (156,5,0) Bold 
 Print 'Unique identifier of the case.' (157,68,0)
 Print 'Percentage of children without Education Detail: ' (366,5,34) Bold  Wrap 34 3 line-height=12 Keep-Top
 Print '(Number of children without Education Detail / Total number of children eligible to have an Education Detail page) * 100' (366,203,94) Wrap 94 2 line-height=12 Keep-Top
 Print 'Percentage of children with Education Detail not updated for past 12 months: ' (391,5,39) Bold  Wrap 39 2 line-height=12 Keep-Top
 Print '(Number of children with Education Detail not updated for past 12 months / Total number of children eligible to have an Education Detail page) * 100' (391,203,94) Wrap 94 2 line-height=12 Keep-Top
   Print-Direct printer=html '%%ResetBorder'
 Alter-Report Heading=Default
              Footing=Default
 Next-Listing
End-Procedure

! Supports a special heading on the first page, which combines the report
! header and the default page header into a single header only for that page,
! changing it back to the default page header for subsequent pages.
Begin-Procedure BRB_After_Page
 If #page-count <= 1
   Alter-Report Heading-Size=60   ! Revert to non-page-1 header size.
 End-If
End-Procedure

Begin-Program
 Do LoadLookupTables
 Position (1,1)
 Do Get-Input-StageType
 Do Get-Input-Region
 Do Get-Input-County
 Do Get-Input-Unit
 Do Get-Input-CaseWorker 

 Do Master_Query
 Do DisplayResult
End-Program
Begin-Procedure Get-Input-StageType
! Get stage optional input
Input $_I101_CD_STAGE 'Enter a value for CD_STAGE' MaxLen=3  Type=Char
If IsNull($_I101_CD_STAGE) or IsBlank($_I101_CD_STAGE) or ($_I101_CD_STAGE = '0')

  Let $where_clause_stage =  'STAGE00.CD_STAGE In' || '('|| '''FSU''' || ',' || '''FPR''' || ')' 
  Let $stageVarText = 'All'
Else 
  Let $where_clause_stage = 'STAGE00.CD_STAGE = ' || '''' || $_I101_CD_STAGE || ''''
  Let $stageVar = $_I101_CD_STAGE
If $stageVar = 'FSU'
  Let $stageVarText = 'Foster Care Family'
Else
  If $stageVar = 'FPR'
   Let $stageVarText = 'Ongoing'
 End-If
End-If
End-If

End-Procedure

! -----------------------------Goptional Region------
Begin-Procedure Get-Input-Region
Input $_I102_CD_STAGE_REGION 'Enter a value for CD_STAGE_REGION' MaxLen=2  Type=Char
If IsNull($_I102_CD_STAGE_REGION) or IsBlank($_I102_CD_STAGE_REGION) or ($_I102_CD_STAGE_REGION) = '0'
    Let $_where_clause102 = 'STAGE00.CD_STAGE_REGION is not null'
    Let $regSelected = 'N'   
   
Else
 Let $regSelected = 'Y'
 Let $_region2 = $_I102_CD_STAGE_REGION 
If SubStr($_I102_CD_STAGE_REGION, 1, 1) != ''''
  Let $_I102_CD_STAGE_REGION = '''' || $_I102_CD_STAGE_REGION || ''''
End-If
 ! The input-variable is a CHAR; auto-add quotes in case the user doesn't.
 ! Exception - don't auto-add if user entered a list (ie, has comma(s))
 Let $BRBSkipThis = 'F'  ! Override conditionals by inserting user-line to set to 'T'
 If (instr($_I102_CD_STAGE_REGION,'''',0) = 0 and instr($_I102_CD_STAGE_REGION,',',0) = 0 and $BRBSkipThis = 'F')
   ! no quotes, no commas - add quotes
   Let $brb_tmp = 'STAGE00.CD_STAGE_REGION'
   Let $_where_clause102 = $brb_tmp  || ' = ' ||  '''' || $_I102_CD_STAGE_REGION || '''' 
 Else
   If (instr($_I102_CD_STAGE_REGION,'''',0) = 0 and instr($_I102_CD_STAGE_REGION,',',0) > 0 and $BRBSkipThis = 'F')
      ! no quotes, has commas - database won't accept
       Show 'Multiple CHAR entries must each be wrapped in quotes'
       Let #return-status = 3701
       Stop
   Else
     ! quotes, no commas - process variable as-is
     Let $brb_tmp = 'STAGE00.CD_STAGE_REGION'
     Let $_where_clause102 = $brb_tmp  || ' = ' || $_I102_CD_STAGE_REGION
   End-If
 End-If
!Let $where_clause103 = ' CODE = ''' || $_I101_CD_COUNTY || ''''
End-If
End-Procedure

Begin-Procedure Get-Input-County
! -----------------------------
Input $_I101_CD_STAGE_CNTY 'Enter a value for CD_STAGE_CNTY' MaxLen=3  Type=Char
If IsNull($_I101_CD_STAGE_CNTY) or IsBlank($_I101_CD_STAGE_CNTY) or ($_I101_CD_STAGE_CNTY) = '0'
   Let $_where_clause101 = 'STAGE00.CD_STAGE_CNTY is not null'  
   Let $cntySelected = 'N'

Else
 Let $brb_tmp3 = 'STAGE00.CD_STAGE_CNTY' 

 Let $cntySelected = 'Y'
If SubStr($_I101_CD_STAGE_CNTY, 1, 1) != ''''
  Let $_I101_CD_STAGE_CNTY = '''' || $_I101_CD_STAGE_CNTY || ''''
End-If
 ! The input-variable is a CHAR; auto-add quotes in case the user doesn't.
 ! Exception - don't auto-add if user entered a list (ie, has comma(s))
 Let $BRBSkipThis = 'F'  ! Override conditionals by inserting user-line to set to 'T'
 If (instr($_I101_CD_STAGE_CNTY,'''',0) = 0 and instr($_I101_CD_STAGE_CNTY,',',0) = 0 and $BRBSkipThis = 'F')
   ! no quotes, no commas - add quotes
   Let $brb_tmp = 'STAGE00.CD_STAGE_CNTY'
   Let $_where_clause101 = $brb_tmp  || ' = ' ||  '''' || $_I101_CD_STAGE_CNTY || '''' 
 Else
   If (instr($_I101_CD_STAGE_CNTY,'''',0) = 0 and instr($_I101_CD_STAGE_CNTY,',',0) > 0 and $BRBSkipThis = 'F')
      ! no quotes, has commas - database won't accept
       Show 'Multiple CHAR entries must each be wrapped in quotes'
       Let #return-status = 3701
       Stop
   Else
     ! quotes, no commas - process variable as-is
     Let $brb_tmp = 'STAGE00.CD_STAGE_CNTY'
     Let $_where_clause101 = $brb_tmp  || ' = ' || $_I101_CD_STAGE_CNTY
   End-If
 End-If
End-if

If $cntySelected = 'Y'
Begin-Select Loops=1
DECODE &_County_Decode
From  CCOUNT
Where CCOUNT.CODE = [$_I101_CD_STAGE_CNTY]
End-Select
  Move &_County_Decode to $_headerDisp
Else
  If $regSelected = 'Y'
    Let $_headerDisp = 'Region ' || $_region2
  Else 
    Let $_headerDisp = 'Statewide'
  End-If
End-If

End-Procedure
Begin-Procedure Get-Input-Unit
! -----------------------------
Input $_I101_NBR_UNIT 'Enter a value for NBR_UNIT' MaxLen=2  Type=Char
If IsNull($_I101_NBR_UNIT) or IsBlank($_I101_NBR_UNIT) or ($_I101_NBR_UNIT) = '0'
  Let $_where_clause103 = 'NBR_UNIT is not null'
  Let $unitSelected = 'N'
  Let $unitVar = 'All'
 Else
 Let $unitSelected = 'Y'
 Let $unitVar = $_I101_NBR_UNIT
If SubStr($_I101_NBR_UNIT, 1, 1) != ''''
  Let $_I101_NBR_UNIT = '''' || $_I101_NBR_UNIT || ''''
End-If
 ! The input-variable is a CHAR; auto-add quotes in case the user doesn't.
 ! Exception - don't auto-add if user entered a list (ie, has comma(s))
 Let $BRBSkipThis = 'F'  ! Override conditionals by inserting user-line to set to 'T'
 If (instr($_I101_NBR_UNIT,'''',0) = 0 and instr($_I101_NBR_UNIT,',',0) = 0 and $BRBSkipThis = 'F')
   ! no quotes, no commas - add quotes
   Let $brb_tmp = 'NBR_UNIT'
   Let $_where_clause103 = $brb_tmp  || ' = ' ||  '''' || $_I101_NBR_UNIT || '''' 
 Else
   If (instr($_I101_NBR_UNIT,'''',0) = 0 and instr($_I101_NBR_UNIT,',',0) > 0 and $BRBSkipThis = 'F')
      ! no quotes, has commas - database won't accept
       Show 'Multiple CHAR entries must each be wrapped in quotes'
       Let #return-status = 3701
       Stop
   Else
     ! quotes, no commas - process variable as-is
     Let $brb_tmp = 'NBR_UNIT'
     Let $_where_clause103 = $brb_tmp  || ' = ' || $_I101_NBR_UNIT
   End-If
 End-If
End-If
End-Procedure
! -----------------------------

Begin-Procedure Get-Input-CaseWorker
Input $_I102_STAGE_PERSON_LINK_ID_PERSON 'Enter a value for ID_PERSON' MaxLen=16  Type=Number
If IsNull($_I102_STAGE_PERSON_LINK_ID_PERSON) or IsBlank($_I102_STAGE_PERSON_LINK_ID_PERSON) or ($_I102_STAGE_PERSON_LINK_ID_PERSON) = '0'
  Let $_where_clause104 = 'STAGE_PERSON_LINK.ID_PERSON is not null'
  Let $cmSelected = 'N'
  Else
 Let $cmSelected = 'Y'
Let $brb_tmp = 'STAGE_PERSON_LINK.ID_PERSON'
Let $_where_clause104 = $brb_tmp  || ' = ' || $_I102_STAGE_PERSON_LINK_ID_PERSON
End-if
End-Procedure

Begin-Procedure Find-EduPrograms(#ChildID2, :$str_EduNeeds)
Begin-Select DISTINCT 
cd_edhist_needs_1 &edPrgs 
 If isnull($str_EduNeeds) or isblank($str_EduNeeds) and not(isnull(&edPrgs))
  Move &edPrgs to $str_EduNeeds
 Else
 if not(isnull(&edPrgs))
  Let $str_EduNeeds = $str_EduNeeds || ', ' || &edPrgs
 End-If
 End-If
cd_edhist_needs_2 &edPrgs2
 If isnull($str_EduNeeds) or isblank($str_EduNeeds) and not(isnull(&edPrgs2))
  Move &edPrgs2 to $str_EduNeeds
 Else
 if not(isnull(&edPrgs2))
  Let $str_EduNeeds = $str_EduNeeds || ', ' || &edPrgs2 
 End-If 
 End-If
cd_edhist_needs_3 &edPrgs3
 If isnull($str_EduNeeds) or isblank($str_EduNeeds) and not(isnull(&edPrgs3))
  Move &edPrgs3 to $str_EduNeeds
 Else
 if not(isnull(&edPrgs3))
  Let $str_EduNeeds = $str_EduNeeds || ', ' || &edPrgs3
 End-If
 End-If
cd_edhist_needs_4 &edPrgs4
 If isnull($str_EduNeeds) or isblank($str_EduNeeds) and not(isnull(&edPrgs4))
  Move &edPrgs4 to $str_EduNeeds
 Else
 if not(isnull(&edPrgs4))
  Let $str_EduNeeds = $str_EduNeeds || ', ' || &edPrgs4
 End-If
 End-If
cd_edhist_needs_5 &edPrgs5
 If isnull($str_EduNeeds) or isblank($str_EduNeeds) and not(isnull(&edPrgs5))
  Move &edPrgs5 to $str_EduNeeds
 Else
 if not(isnull(&edPrgs5))
  Let $str_EduNeeds = $str_EduNeeds || ', ' || &edPrgs5
 End-If
 End-If
cd_edhist_needs_6 &edPrgs6
 If isnull($str_EduNeeds) or isblank($str_EduNeeds) and not(isnull(&edPrgs6))
  Move &edPrgs6 to $str_EduNeeds
 Else
  if not(isnull(&edPrgs6))
  Let $str_EduNeeds = $str_EduNeeds || ', ' || &edPrgs6
  end-if
 End-If
cd_edhist_needs_7 &edPrgs7
 If isnull($str_EduNeeds) or isblank($str_EduNeeds) and not(isnull(&edPrgs7))
  Move &edPrgs7 to $str_EduNeeds
 Else
  if not(isnull(&edPrgs7))
  Let $str_EduNeeds = $str_EduNeeds || ', ' || &edPrgs7
  End-If
 End-If
cd_edhist_needs_8 &edPrgs8
 If isnull($str_EduNeeds) or isblank($str_EduNeeds) and not(isnull(&edPrgs8))
  Move &edPrgs8 to $str_EduNeeds
 Else
 if not(isnull(&edPrgs8))
  Let $str_EduNeeds = $str_EduNeeds || ', ' || &edPrgs8
 End-If
 End-If
cd_edhist_needs_9 &edPrgs9
 If isnull($str_EduNeeds) or isblank($str_EduNeeds) and not(isnull(&edPrgs9))
  Move &edPrgs9 to $str_EduNeeds
 Else
 if not(isnull(&edPrgs9))
  Let $str_EduNeeds = $str_EduNeeds || ', ' || &edPrgs9
 End-If
 End-If
cd_edhist_needs_10 &edPrgs10
 If isnull($str_EduNeeds) or isblank($str_EduNeeds) and not(isnull(&edPrgs10))
  Move &edPrgs to $str_EduNeeds
 Else
 if not(isnull(&edPrgs10))
  Let $str_EduNeeds = $str_EduNeeds || ', ' || &edPrgs10
 End-If
 End-If
FROM 
 EDUCATIONAL_HISTORY 
 where EDUCATIONAL_HISTORY.id_person = #ChildID2
 and id_edhist = (select max(ed2.id_edhist) from educational_history ed2 where ed2.id_person = EDUCATIONAL_HISTORY.id_person
 group by ed2.id_person)     
End-Select
End-Procedure

!-----Calculating the total number of children with no education detail or not updated ---------------------

Begin-Procedure EdDtlUpdateOrNot(#ChildID2, :#_CNT_EDDTLYes, :#_CNT_EDDTLNo) 
BEGIN-SELECT
EH.DT_LAST_UPDATE &Date_Updated
 FROM CAPS.EDUCATIONAL_HISTORY EH, PERSON PERSON2
WHERE 
 PERSON2.ID_PERSON = EH.ID_PERSON(+)
AND PERSON2.ID_PERSON = #ChildID2
and EH.ID_EDHIST = (select max(ed2.id_edhist) from educational_history ed2 where ed2.id_person = EH.id_person
 group by ed2.id_person) 
END-SELECT
If IsNull (&Date_Updated) 
 ADD 1 TO #NoEdDtl
ELSE
 ADD 1 TO #EdDtlNotUpdated
END-IF
MOVE #EdDtlNotUpdated TO #_CNT_EDDTLYes
MOVE #NoEdDtl TO #_CNT_EDDTLNo
END-PROCEDURE
!----------------------------------------------------------
Begin-Procedure WithOutEdDtl
! Move 0 to #_cntWODtl
begin-select 
count(distinct PERSON_Child.ID_PERSON) &_cWODtl
FROM 
    CAPS.STAGE STAGE00, CAPS.UNIT, CAPS.CCOUNT, CAPS.STAGE_PERSON_LINK, CAPS.PERSON PERSON_CM, 
    CAPS.PERSON PERSON_Sup, CAPS.YOUTH_DETAIL,   CAPS.EDUCATIONAL_HISTORY,
  CAPS.STAGE_PERSON_LINK STAGE_PERSON_LINK_Child,  CAPS.PERSON PERSON_Child
WHERE
    STAGE00.CD_STAGE_CNTY = CAPS.CCOUNT.CODE  AND 
    CAPS.STAGE_PERSON_LINK.ID_PERSON = PERSON_CM.ID_PERSON  AND 
    STAGE_PERSON_LINK_Child.ID_PERSON = PERSON_Child.ID_PERSON  AND 
    STAGE00.ID_CASE = STAGE_PERSON_LINK_Child.ID_CASE  AND 
    STAGE00.ID_STAGE = CAPS.STAGE_PERSON_LINK.ID_STAGE  AND 
    STAGE00.ID_CASE = CAPS.STAGE_PERSON_LINK.ID_CASE  AND 
    CAPS.UNIT.ID_PERSON = PERSON_Sup.ID_PERSON  AND 
    STAGE00.ID_UNIT = CAPS.UNIT.ID_UNIT  
 AND [$_where_clause101] 
 AND [$_where_clause102] 
 AND STAGE_PERSON_LINK.CD_STAGE_PERS_ROLE in ('PR') 
 AND [$_where_clause103] 
 AND [$_where_clause104] 
 AND PERSON_Child.ID_PERSON = EDUCATIONAL_HISTORY.ID_PERSON (+) AND 
    PERSON_Child.ID_PERSON =  YOUTH_DETAIL.ID_PERSON(+) AND 
((STAGE00.CD_STAGE in ('FSU') 
   AND  STAGE_PERSON_LINK_Child.CD_STAGE_PERS_ROLE  = 'PC' AND 
      ADD_MONTHS( PERSON_Child.DT_PERSON_BIRTH ,12*5) <= sysdate 
    and ADD_MONTHS( PERSON_Child.DT_PERSON_BIRTH ,12*20) > sysdate AND 
    ((PERSON_Child.ID_PERSON in (select lv2.id_person from legal_status_view lv2, person p2,stage s2, stage_person_link spl2 
where   p2.id_person = lv2.id_person and lv2.id_case = s2.id_case and s2.id_case = spl2.id_case and s2.id_stage = spl2.id_stage and s2.cd_stage in ('SUB','ADO') and spl2.id_person = lv2.id_person and 
  spl2.cd_stage_pers_role ='PC' and lv2.id_person in (select lvs.id_person from legal_status_view lvs where lvs.id_legal_stat_event= (select max(lvs2.id_legal_stat_event) from legal_status_view lvs2 
  where lvs.id_person =lvs2.id_person and lvs.id_case = lvs2.id_case and lvs2.in_dfcs_custody = 'Y' and lvs2.DT_LEGAL_STAT_END = to_date('12/31/4712','MM/DD/YYYY') ) and lvs.id_person =lv2.id_person 
  and lvs.id_case = lv2.id_case) and s2.dt_stage_start >= ADD_MONTHS( p2.dt_person_birth ,12*5) 
  and (sysdate -s2.dt_stage_start ) >= 30 and lv2.id_person = PERSON_Child.ID_PERSON and lv2.id_case =STAGE00.ID_CASE )) 
  or (  PERSON_Child.ID_PERSON in (select distinct lv2.id_person 
  from legal_status_view lv2, person p2,stage s2, stage_person_link spl2 where   p2.id_person = lv2.id_person and lv2.id_case = s2.id_case and s2.id_case = spl2.id_case and s2.id_stage = spl2.id_stage and s2.cd_stage in ('SUB','ADO') and 
  spl2.id_person = lv2.id_person and spl2.cd_stage_pers_role ='PC' and lv2.id_person in(select lvs.id_person from legal_status_view lvs 
  where lvs.id_legal_stat_event= (select max(lvs2.id_legal_stat_event) from legal_status_view lvs2 where 
  lvs.id_person =lvs2.id_person and lvs.id_case = lvs2.id_case and lvs2.in_dfcs_custody = 'Y' 
  and lvs2.DT_LEGAL_STAT_END = to_date('12/31/4712','MM/DD/YYYY') ) and lvs.id_person =lv2.id_person 
  and lvs.id_case = lv2.id_case  ) and ADD_MONTHS( p2.dt_person_birth ,12*5) >= s2.dt_stage_start  
  and (sysdate - ADD_MONTHS( p2.dt_person_birth ,12*5))>=30  and lv2.id_person = PERSON_Child.ID_PERSON  
  and lv2.id_case =STAGE00.ID_CASE ))) )    
OR  (STAGE00.CD_STAGE in ('FPR') AND 
    (sysdate - STAGE00.DT_STAGE_START) >= 30 AND 
    exists(select distinct splchild2.id_person from stage_person_link splchild2, stage stage2 where splchild2.id_stage = stage2.id_stage and splchild2.id_case = STAGE00.id_case 
   and splchild2.id_stage = STAGE00.id_stage and stage2.id_case = splchild2.id_case and splchild2.id_person=  STAGE_PERSON_LINK_Child.ID_PERSON and splchild2.cd_pk_hshd_member = 'Y' 
   and splchild2.cd_stage_pers_type = 'PRN' and splchild2.cd_stage_pers_rel_int not in ('BF','LF','PF','BB','LM','BM','PK') ) AND 
    ADD_MONTHS( PERSON_Child.DT_PERSON_BIRTH ,12*5) <= sysdate and ADD_MONTHS( PERSON_Child.DT_PERSON_BIRTH ,12*17) > sysdate)) AND 
    ( EDUCATIONAL_HISTORY.DT_LAST_UPDATE  is null or ( EDUCATIONAL_HISTORY.DT_LAST_UPDATE  = (select edu.dt_last_update from educational_history edu 
   where edu.id_edhist = (select max(ed2.id_edhist) from educational_history ed2 where ed2.id_person = edu.id_person group by ed2.id_person) and edu.id_person =  EDUCATIONAL_HISTORY.ID_PERSON ) 
  and (sysdate-  EDUCATIONAL_HISTORY.DT_LAST_UPDATE ) >= 365 ) ) AND 
    STAGE00.DT_STAGE_CLOSE is null AND 
    [$where_clause_stage]
     and EDUCATIONAL_HISTORY.DT_LAST_UPDATE is null 
End-Select
 Move &_cWODtl to #_cWODtl

End-Procedure
!----------------------------------------------------------
Begin-Procedure WithEdDtl
! Move 0 to #_cntWODtl
begin-select 
count(distinct PERSON_Child.ID_PERSON) &_cWithDtl
FROM 
    CAPS.STAGE STAGE00, CAPS.UNIT, CAPS.CCOUNT, CAPS.STAGE_PERSON_LINK, CAPS.PERSON PERSON_CM, 
    CAPS.PERSON PERSON_Sup, CAPS.YOUTH_DETAIL,   CAPS.EDUCATIONAL_HISTORY,
  CAPS.STAGE_PERSON_LINK STAGE_PERSON_LINK_Child,  CAPS.PERSON PERSON_Child
WHERE
    STAGE00.CD_STAGE_CNTY = CAPS.CCOUNT.CODE  AND 
    CAPS.STAGE_PERSON_LINK.ID_PERSON = PERSON_CM.ID_PERSON  AND 
    STAGE_PERSON_LINK_Child.ID_PERSON = PERSON_Child.ID_PERSON  AND 
    STAGE00.ID_CASE = STAGE_PERSON_LINK_Child.ID_CASE  AND 
    STAGE00.ID_STAGE = CAPS.STAGE_PERSON_LINK.ID_STAGE  AND 
    STAGE00.ID_CASE = CAPS.STAGE_PERSON_LINK.ID_CASE  AND 
    CAPS.UNIT.ID_PERSON = PERSON_Sup.ID_PERSON  AND 
    STAGE00.ID_UNIT = CAPS.UNIT.ID_UNIT  
 AND [$_where_clause101] 
 AND [$_where_clause102] 
 AND STAGE_PERSON_LINK.CD_STAGE_PERS_ROLE in ('PR') 
 AND [$_where_clause103] 
 AND [$_where_clause104] 
 AND PERSON_Child.ID_PERSON = EDUCATIONAL_HISTORY.ID_PERSON (+) AND 
    PERSON_Child.ID_PERSON =  YOUTH_DETAIL.ID_PERSON(+) AND 
((STAGE00.CD_STAGE in ('FSU') 
   AND  STAGE_PERSON_LINK_Child.CD_STAGE_PERS_ROLE  = 'PC' AND 
      ADD_MONTHS( PERSON_Child.DT_PERSON_BIRTH ,12*5) <= sysdate 
    and ADD_MONTHS( PERSON_Child.DT_PERSON_BIRTH ,12*20) > sysdate AND 
    ((PERSON_Child.ID_PERSON in (select lv2.id_person from legal_status_view lv2, person p2,stage s2, stage_person_link spl2 
where   p2.id_person = lv2.id_person and lv2.id_case = s2.id_case and s2.id_case = spl2.id_case and s2.id_stage = spl2.id_stage and s2.cd_stage in ('SUB','ADO') and spl2.id_person = lv2.id_person and 
spl2.cd_stage_pers_role ='PC' and lv2.id_person in (select lvs.id_person from legal_status_view lvs where lvs.id_legal_stat_event= (select max(lvs2.id_legal_stat_event) from legal_status_view lvs2 
where lvs.id_person =lvs2.id_person and lvs.id_case = lvs2.id_case and lvs2.in_dfcs_custody = 'Y' and lvs2.DT_LEGAL_STAT_END = to_date('12/31/4712','MM/DD/YYYY') ) and lvs.id_person =lv2.id_person 
and lvs.id_case = lv2.id_case) and s2.dt_stage_start >= ADD_MONTHS( p2.dt_person_birth ,12*5) 
and (sysdate -s2.dt_stage_start ) >= 30 and lv2.id_person = PERSON_Child.ID_PERSON and lv2.id_case =STAGE00.ID_CASE )) 
or (  PERSON_Child.ID_PERSON in (select distinct lv2.id_person 
from legal_status_view lv2, person p2,stage s2, stage_person_link spl2 where   p2.id_person = lv2.id_person and lv2.id_case = s2.id_case and s2.id_case = spl2.id_case and s2.id_stage = spl2.id_stage and s2.cd_stage in ('SUB','ADO') and 
spl2.id_person = lv2.id_person and spl2.cd_stage_pers_role ='PC' and lv2.id_person in(select lvs.id_person from legal_status_view lvs 
where lvs.id_legal_stat_event= (select max(lvs2.id_legal_stat_event) from legal_status_view lvs2 where 
lvs.id_person =lvs2.id_person and lvs.id_case = lvs2.id_case and lvs2.in_dfcs_custody = 'Y' 
and lvs2.DT_LEGAL_STAT_END = to_date('12/31/4712','MM/DD/YYYY') ) and lvs.id_person =lv2.id_person 
and lvs.id_case = lv2.id_case  ) and ADD_MONTHS( p2.dt_person_birth ,12*5) >= s2.dt_stage_start  
and (sysdate - ADD_MONTHS( p2.dt_person_birth ,12*5))>=30  and lv2.id_person = PERSON_Child.ID_PERSON  
and lv2.id_case =STAGE00.ID_CASE ))) )     
OR  (STAGE00.CD_STAGE in ('FPR') AND 
    (sysdate - STAGE00.DT_STAGE_START) >= 30 AND 
    exists(select distinct splchild2.id_person from stage_person_link splchild2, stage stage2 where splchild2.id_stage = stage2.id_stage and splchild2.id_case = STAGE00.id_case 
   and splchild2.id_stage = STAGE00.id_stage and stage2.id_case = splchild2.id_case and splchild2.id_person=  STAGE_PERSON_LINK_Child.ID_PERSON and splchild2.cd_pk_hshd_member = 'Y' 
   and splchild2.cd_stage_pers_type = 'PRN' and splchild2.cd_stage_pers_rel_int not in ('BF','LF','PF','BB','LM','BM','PK') ) AND 
    ADD_MONTHS( PERSON_Child.DT_PERSON_BIRTH ,12*5) <= sysdate and ADD_MONTHS( PERSON_Child.DT_PERSON_BIRTH ,12*17) > sysdate)) AND 
    ( EDUCATIONAL_HISTORY.DT_LAST_UPDATE  is null or ( EDUCATIONAL_HISTORY.DT_LAST_UPDATE  = (select edu.dt_last_update from educational_history edu 
   where edu.id_edhist = (select max(ed2.id_edhist) from educational_history ed2 where ed2.id_person = edu.id_person group by ed2.id_person) and edu.id_person =  EDUCATIONAL_HISTORY.ID_PERSON ) 
  and (sysdate-  EDUCATIONAL_HISTORY.DT_LAST_UPDATE ) >= 365 ) ) AND 
    STAGE00.DT_STAGE_CLOSE is null AND 
    [$where_clause_stage]
     and EDUCATIONAL_HISTORY.DT_LAST_UPDATE is not null
End-Select
 Move &_cWithDtl to #_cWithDtl

End-Procedure

Begin-Procedure countTotalChildren
Begin-Select 
count(distinct PERSON_Child.ID_PERSON) &_cTotalChild
FROM 
    CAPS.STAGE STAGE00, CAPS.UNIT, CAPS.CCOUNT, CAPS.STAGE_PERSON_LINK, CAPS.PERSON PERSON_CM, 
    CAPS.PERSON PERSON_Sup, CAPS.YOUTH_DETAIL,   CAPS.EDUCATIONAL_HISTORY,
  CAPS.STAGE_PERSON_LINK STAGE_PERSON_LINK_Child,  CAPS.PERSON PERSON_Child
WHERE
    STAGE00.CD_STAGE_CNTY = CAPS.CCOUNT.CODE  AND 
    CAPS.STAGE_PERSON_LINK.ID_PERSON = PERSON_CM.ID_PERSON  AND 
    STAGE_PERSON_LINK_Child.ID_PERSON = PERSON_Child.ID_PERSON  AND 
    STAGE00.ID_CASE = STAGE_PERSON_LINK_Child.ID_CASE  AND 
    STAGE00.ID_STAGE = CAPS.STAGE_PERSON_LINK.ID_STAGE  AND 
    STAGE00.ID_CASE = CAPS.STAGE_PERSON_LINK.ID_CASE  AND 
    CAPS.UNIT.ID_PERSON = PERSON_Sup.ID_PERSON  AND 
    STAGE00.ID_UNIT = CAPS.UNIT.ID_UNIT  
 AND [$_where_clause101] 
 AND [$_where_clause102] 
 AND STAGE_PERSON_LINK.CD_STAGE_PERS_ROLE in ('PR') 
 AND [$_where_clause103] 
 AND [$_where_clause104] 
 AND PERSON_Child.ID_PERSON = EDUCATIONAL_HISTORY.ID_PERSON (+) AND 
    PERSON_Child.ID_PERSON =  YOUTH_DETAIL.ID_PERSON(+) AND 
((STAGE00.CD_STAGE in ('FSU') 
   AND  STAGE_PERSON_LINK_Child.CD_STAGE_PERS_ROLE  = 'PC' AND 
      ADD_MONTHS( PERSON_Child.DT_PERSON_BIRTH ,12*5) <= sysdate 
    and ADD_MONTHS( PERSON_Child.DT_PERSON_BIRTH ,12*20) > sysdate AND 
    ((PERSON_Child.ID_PERSON in (select lv2.id_person from legal_status_view lv2, person p2,stage s2, stage_person_link spl2 
where   p2.id_person = lv2.id_person and lv2.id_case = s2.id_case and s2.id_case = spl2.id_case and s2.id_stage = spl2.id_stage and s2.cd_stage in ('SUB','ADO') and spl2.id_person = lv2.id_person and 
spl2.cd_stage_pers_role ='PC' and lv2.id_person in (select lvs.id_person from legal_status_view lvs where lvs.id_legal_stat_event= (select max(lvs2.id_legal_stat_event) from legal_status_view lvs2 
where lvs.id_person =lvs2.id_person and lvs.id_case = lvs2.id_case and lvs2.in_dfcs_custody = 'Y' and lvs2.DT_LEGAL_STAT_END = to_date('12/31/4712','MM/DD/YYYY') ) and lvs.id_person =lv2.id_person 
and lvs.id_case = lv2.id_case) and s2.dt_stage_start >= ADD_MONTHS( p2.dt_person_birth ,12*5) 
and (sysdate -s2.dt_stage_start ) >= 30 and lv2.id_person = PERSON_Child.ID_PERSON and lv2.id_case =STAGE00.ID_CASE )) 
or (  PERSON_Child.ID_PERSON in (select distinct lv2.id_person 
from legal_status_view lv2, person p2,stage s2, stage_person_link spl2 where   p2.id_person = lv2.id_person and lv2.id_case = s2.id_case and s2.id_case = spl2.id_case and s2.id_stage = spl2.id_stage and s2.cd_stage in ('SUB','ADO') and 
spl2.id_person = lv2.id_person and spl2.cd_stage_pers_role ='PC' and lv2.id_person in(select lvs.id_person from legal_status_view lvs 
where lvs.id_legal_stat_event= (select max(lvs2.id_legal_stat_event) from legal_status_view lvs2 where 
lvs.id_person =lvs2.id_person and lvs.id_case = lvs2.id_case and lvs2.in_dfcs_custody = 'Y' 
and lvs2.DT_LEGAL_STAT_END = to_date('12/31/4712','MM/DD/YYYY') ) and lvs.id_person =lv2.id_person 
and lvs.id_case = lv2.id_case  ) and ADD_MONTHS( p2.dt_person_birth ,12*5) >= s2.dt_stage_start  
and (sysdate - ADD_MONTHS( p2.dt_person_birth ,12*5))>=30  and lv2.id_person = PERSON_Child.ID_PERSON  
and lv2.id_case =STAGE00.ID_CASE ))) )     
OR  (STAGE00.CD_STAGE in ('FPR') AND 
    (sysdate - STAGE00.DT_STAGE_START) >= 30 AND 
    exists(select distinct splchild2.id_person from stage_person_link splchild2, stage stage2 where splchild2.id_stage = stage2.id_stage and splchild2.id_case = STAGE00.id_case 
   and splchild2.id_stage = STAGE00.id_stage and stage2.id_case = splchild2.id_case and splchild2.id_person=  STAGE_PERSON_LINK_Child.ID_PERSON and splchild2.cd_pk_hshd_member = 'Y' 
   and splchild2.cd_stage_pers_type = 'PRN' and splchild2.cd_stage_pers_rel_int not in ('BF','LF','PF','BB','LM','BM','PK') ) AND 
    ADD_MONTHS( PERSON_Child.DT_PERSON_BIRTH ,12*5) <= sysdate and ADD_MONTHS( PERSON_Child.DT_PERSON_BIRTH ,12*17) > sysdate)) AND 
    STAGE00.DT_STAGE_CLOSE is null AND 
    [$where_clause_stage] 
End-Select
 Move &_cTotalChild to #_cTotalChild
End-Procedure

!----Percentage 1 ----
Begin-Procedure Calc_Percentage1(#_cWODtl,#_cWithDtl,#_cTotalChild,:#percentNo,:#percentYes)
 If #_cTotalChild = 0    
    Let #Var_percentNo= 0
    Let #Var_percentYes = 0
  Else    
    Let #Var_percentNo =  (#_cWODtl/(#_cTotalChild)) * 100
    Let #Var_percentYes = (#_cWithDtl/(#_cTotalChild)) * 100
  End-If
  !Move #Var_PER_CNT_EDDTLYes to #PER_CNT_EDDTLYes
  Move #Var_percentNo  to #percentNo
  Move #Var_percentYes to #percentYes
End-Procedure

!--------------Calculating the Percentage -----------------------------------------------------

Begin-Procedure Calc-Percentage(#stgcnt, #_CNT_EDDTLYes, #_CNT_EDDTLNo, :#PER_CNT_EDDTLYes, :#PER_CNT_EDDTLNo)
  If #stgcnt = 0
    Let #Var_PER_CNT_EDDTLYes= 0
    Let #Var_PER_CNT_EDDTLNo= 0
  Else
    Let #Var_PER_CNT_EDDTLYes = (#_CNT_EDDTLYes/#stgcnt) * 100
    Let #Var_PER_CNT_EDDTLNo =  (#_CNT_EDDTLNo/#stgcnt) * 100
  End-If
  Move #Var_PER_CNT_EDDTLYes to #PER_CNT_EDDTLYes
  Move #Var_PER_CNT_EDDTLNo  to #PER_CNT_EDDTLNo
End-Procedure



Begin-Procedure Master_Query
 Do CreateXML_ManifestFile
 Move 0 To #1ROW_COUNT
Begin-Select Distinct
STAGE_PERSON_LINK_Child.ID_PERSON &ChildID2
!CAPS.EDUCATIONAL_HISTORY.DT_LAST_UPDATE &dtlastupdate Edit MM/DD/YYYY

 Move '' to $str_EduNeeds
 Do Find-EduPrograms(&ChildID2,$str_EduNeeds)
! DO EdDtlUpdateOrNot(&ChildID2, #_CNT_EDDTLYes, #_CNT_EDDTLNo) 
! Do EdDtlUpdateNot(&ChildID2,#_CNT_EDDTLNo)
 Do WithOutEdDtl
 Do WithEdDtl
 Do countTotalChildren
(case when  (EDUCATIONAL_HISTORY.DT_LAST_UPDATE is null and EDUCATIONAL_HISTORY.DT_EDU_PLAN is null) then ''  end) &IEPYesNo
(floor((sysdate -  PERSON_Child.DT_PERSON_BIRTH) / 365.00)) &calcAge
(case when (YOUTH_DETAIL.IND_GED_PROG is null  and  EDUCATIONAL_HISTORY.DT_LAST_UPDATE is null) then '' end) &t1
(case when (YOUTH_DETAIL.IND_GED_PROG is not null  and  EDUCATIONAL_HISTORY.DT_LAST_UPDATE is not null) then 'Yes' end) &t3
(case when  (EDUCATIONAL_HISTORY.DT_LAST_UPDATE is not null and EDUCATIONAL_HISTORY.DT_EDU_PLAN is null) then 'No'  end) &IEPYesNo2
(case when  (EDUCATIONAL_HISTORY.DT_LAST_UPDATE is not null and EDUCATIONAL_HISTORY.DT_EDU_PLAN is not null) then 'Yes'  end) &IEPYesNo3
(case when ( YOUTH_DETAIL.NM_INST  is null  and  EDUCATIONAL_HISTORY.DT_LAST_UPDATE is null) then '' end) &PostSec1
(case when ( YOUTH_DETAIL.NM_INST is null and  EDUCATIONAL_HISTORY.DT_LAST_UPDATE is not null) then 'No' end) &PostSec2
(case when ( YOUTH_DETAIL.NM_INST is not null and  EDUCATIONAL_HISTORY.DT_LAST_UPDATE is not null) then 'Yes' end) &PostSec3
(case when (YOUTH_DETAIL.IND_GED_PROG is null  and  EDUCATIONAL_HISTORY.DT_LAST_UPDATE is not null) then 'No' end) &t2
STAGE00.NM_STAGE &Master_Query_STAGE00.NM_STAGE
CD_COUNTY &Master_Query_CD_COUNTY
STAGE00.CD_STAGE_CNTY &Master_Query_STAGE00.CD_STAGE_CNTY
CODE &ccountcode
STAGE00.DT_STAGE_CLOSE &stageClose
NBR_UNIT &Master_Query_NBR_UNIT
PERSON_Sup.NM_PERSON_FULL &SupervisorNm
PERSON_CM.NM_PERSON_FULL &CMName
STAGE00.ID_STAGE &Master_Query_STAGE00.ID_STAGE
PERSON_Child.NBR_PERSON_AGE &Master_Query_PERSON_Child.NBR_PERSON_AGE
CD_CURR_GRADE &Master_Query_CD_CURR_GRADE
DT_EDU_PLAN &Master_Query_DT_EDU_PLAN
IND_GED_PROG &Master_Query_IND_GED_PROG
NM_INST &Master_Query_NM_INST
(case when YOUTH_DETAIL.IND_GED_PROG is null then 'No' else 'Yes' end) &indGEDYesNo
 Alter-Printer Font=4 Point-Size=10    ! [SQR.INI] 4=Arial,proportional
STAGE00.CD_STAGE_REGION &Master_Query_STAGE00.CD_STAGE_REGION () On-Break Set=1 Level=1 Print=Never Before=Master_QueryCD_STAGE_REGION_BeforeProc101 After=Master_QueryCD_STAGE_REGION_AfterProc101
DECODE &Master_Query_DECODE () On-Break Set=1 Level=2 Print=Never Before=Master_QueryDECODE_BeforeProc102 After=Master_QueryDECODE_AfterProc102
CAPS.UNIT.ID_UNIT &Master_Query_CAPS.UNIT.ID_UNIT () On-Break Set=1 Level=3 Print=Never Before=Master_QueryID_UNIT_BeforeProc103 After=Master_QueryID_UNIT_AfterProc103
PERSON_CM.ID_PERSON &CMID () On-Break Set=1 Level=4 Print=Never Before=Master_QueryID_PERSON_BeforeProc104 After=Master_QueryID_PERSON_AfterProc104
PERSON_Child.ID_PERSON &ChildID () On-Break Set=1 Level=5 Print=Never After=Master_QueryID_PERSON_AfterProc105
STAGE00.ID_CASE &CaseId (16,100) Edit 99999999999na
PERSON_Child.DT_PERSON_BIRTH &Master_Query_PERSON_Child.DT_PERSON_BIRTH (16,220) Edit MM/DD/YYYY
NM_EDHIST_SCHOOL &Master_Query_NM_EDHIST_SCHOOL (16,299,18) Wrap 18 2 line-height=12 Keep-Top on= 
CD_EDHIST_TYPE &Master_Query_CD_EDHIST_TYPE (16,464,4)
CAPS.EDUCATIONAL_HISTORY.DT_LAST_UPDATE &Master_Query_CAPS.EDUCATIONAL_HISTORY.DT_LAST_UPDATE (16,555) Edit MM/DD/YYYY
 Print &IEPYesNo (16,617,3)
 Print &calcAge (16,279) Edit 99na
 Let $edPrgs=$str_EduNeeds
 Print $edPrgs (16,499,11) Wrap 11 2 line-height=12 Keep-Top on= 
 Print &t1 (16,2,0)
 Print &t3 (16,647,3)
 Print &IEPYesNo2 (16,617,3)
 Print &IEPYesNo3 (16,618,3)
STAGE00.DT_STAGE_START &stageStart (16,164) Edit MM/DD/YYYY
 Print &PostSec1 (16,673,8)
 Print &PostSec2 (16,676,8)
 Print &PostSec3 (16,674,8)
 Print &t1 (16,647,3)
PERSON_Child.NM_PERSON_FULL &Child_Name (16,3,17) Wrap 17 2 line-height=12 Keep-Top
 Print &t2 (16,645,3)
CAPS.EDUCATIONAL_HISTORY.ID_PERSON &Master_Query_CAPS.EDUCATIONAL_HISTORY.ID_PERSON
 Do Grade_Query(&Master_Query_CAPS.EDUCATIONAL_HISTORY.ID_PERSON)
 Print &currEnrollGr (17,402,9) Wrap 9 3 line-height=12 Keep-Top
 Add 1 To #1ROW_COUNT
 Next-Listing  Need=22
From  CAPS.STAGE STAGE00, CAPS.UNIT
,      CAPS.CCOUNT, CAPS.STAGE_PERSON_LINK, CAPS.PERSON PERSON_CM
,      CAPS.PERSON PERSON_Sup, CAPS.YOUTH_DETAIL, CAPS.EDUCATIONAL_HISTORY
,      CAPS.STAGE_PERSON_LINK STAGE_PERSON_LINK_Child, CAPS.PERSON PERSON_Child
      Where STAGE00.CD_STAGE_CNTY = CAPS.CCOUNT.CODE
            And CAPS.STAGE_PERSON_LINK.ID_PERSON = PERSON_CM.ID_PERSON
            And STAGE_PERSON_LINK_Child.ID_PERSON = PERSON_Child.ID_PERSON
            And STAGE00.ID_CASE = STAGE_PERSON_LINK_Child.ID_CASE
            And STAGE00.ID_STAGE = CAPS.STAGE_PERSON_LINK.ID_STAGE
            And STAGE00.ID_CASE = CAPS.STAGE_PERSON_LINK.ID_CASE
            And CAPS.UNIT.ID_PERSON = PERSON_Sup.ID_PERSON
            And STAGE00.ID_UNIT = CAPS.UNIT.ID_UNIT
 And [$_where_clause101]
 And [$_where_clause102]
 And STAGE_PERSON_LINK.CD_STAGE_PERS_ROLE in ('PR')
 And [$_where_clause103]
 And [$_where_clause104]
 And PERSON_Child.ID_PERSON = EDUCATIONAL_HISTORY.ID_PERSON (+)
 And PERSON_Child.ID_PERSON =  YOUTH_DETAIL.ID_PERSON(+)
 And ((STAGE00.CD_STAGE in ('FSU')
 And STAGE_PERSON_LINK_Child.CD_STAGE_PERS_ROLE  = 'PC'
 And ADD_MONTHS( PERSON_Child.DT_PERSON_BIRTH ,12*5) <= sysdate and ADD_MONTHS( PERSON_Child.DT_PERSON_BIRTH ,12*20) > sysdate
 And ((PERSON_Child.ID_PERSON in (select lv2.id_person from legal_status_view lv2, person p2,stage s2, stage_person_link spl2 where   p2.id_person
     = lv2.id_person and lv2.id_case = s2.id_case and s2.id_case = spl2.id_case and s2.id_stage = spl2.id_stage and s2.cd_stage in ('SUB'
    ,'ADO') and spl2.id_person = lv2.id_person and spl2.cd_stage_pers_role ='PC' and lv2.id_person in (select lvs.id_person from legal_status_view
     lvs where lvs.id_legal_stat_event= (select max(lvs2.id_legal_stat_event) from legal_status_view lvs2 where lvs.id_person =lvs2.id_person
     and lvs.id_case = lvs2.id_case and lvs2.in_dfcs_custody = 'Y' and lvs2.DT_LEGAL_STAT_END = to_date('12/31/4712','MM/DD/YYYY') ) and lvs.id_person
     =lv2.id_person and lvs.id_case = lv2.id_case) and s2.dt_stage_start >= ADD_MONTHS( p2.dt_person_birth ,12*5) and (sysdate -s2.dt_stage_start
     ) >= 30 and lv2.id_person = PERSON_Child.ID_PERSON and lv2.id_case =STAGE00.ID_CASE ))  or (PERSON_Child.ID_PERSON in (select distinct
     lv2.id_person from legal_status_view lv2, person p2,stage s2, stage_person_link spl2 where   p2.id_person = lv2.id_person and lv2.id_case
     = s2.id_case and s2.id_case = spl2.id_case and s2.id_stage = spl2.id_stage and s2.cd_stage in ('SUB','ADO') and spl2.id_person = lv2.id_person
     and spl2.cd_stage_pers_role ='PC' and lv2.id_person in(select lvs.id_person from legal_status_view lvs where lvs.id_legal_stat_event
    = (select max(lvs2.id_legal_stat_event) from legal_status_view lvs2 where lvs.id_person =lvs2.id_person and lvs.id_case = lvs2.id_case
     and lvs2.in_dfcs_custody = 'Y' and lvs2.DT_LEGAL_STAT_END = to_date('12/31/4712','MM/DD/YYYY') ) and lvs.id_person =lv2.id_person and
     lvs.id_case = lv2.id_case  ) and ADD_MONTHS( p2.dt_person_birth ,12*5) >= s2.dt_stage_start  and (sysdate - ADD_MONTHS( p2.dt_person_birth
     ,12*5))>=30  and lv2.id_person = PERSON_Child.ID_PERSON  and lv2.id_case =STAGE00.ID_CASE )))) Or (STAGE00.CD_STAGE in ('FPR')
 And (sysdate - STAGE00.DT_STAGE_START) >= 30
 And exists(select distinct splchild2.id_person from stage_person_link splchild2, stage stage2 where splchild2.id_stage = stage2.id_stage and
     splchild2.id_case = STAGE00.id_case and splchild2.id_stage = STAGE00.id_stage and stage2.id_case = splchild2.id_case and splchild2.id_person
    =  STAGE_PERSON_LINK_Child.ID_PERSON and splchild2.cd_pk_hshd_member = 'Y' and splchild2.cd_stage_pers_type = 'PRN' and splchild2.cd_stage_pers_rel_int
     not in ('BF','LF','PF','BB','LM','BM','PK') )
 And ADD_MONTHS( PERSON_Child.DT_PERSON_BIRTH ,12*5) <= sysdate and ADD_MONTHS( PERSON_Child.DT_PERSON_BIRTH ,12*17) > sysdate))
 And ( EDUCATIONAL_HISTORY.DT_LAST_UPDATE  is null or ( EDUCATIONAL_HISTORY.DT_LAST_UPDATE  = (select edu.dt_last_update from educational_history
     edu where edu.id_edhist = (select max(ed2.id_edhist) from educational_history ed2 where ed2.id_person = edu.id_person group by ed2.id_person)
     and edu.id_person =  EDUCATIONAL_HISTORY.ID_PERSON ) and (sysdate-  EDUCATIONAL_HISTORY.DT_LAST_UPDATE ) >= 365 ) )
 And STAGE00.DT_STAGE_CLOSE is null
 And [$where_clause_stage]
Order By STAGE00.CD_STAGE_REGION
,      DECODE
,      NBR_UNIT
,      CAPS.UNIT.ID_UNIT
,      PERSON_CM.NM_PERSON_FULL
,      STAGE00.ID_CASE
,      PERSON_Child.NM_PERSON_FULL
End-Select
 Next-Listing
 Next-Listing  Need=114
 If #1ROW_COUNT > 0
 Graphic (5,1,717) Horz-Line 17 
 Position (6,1)
 Alter-Printer Font=4 Point-Size=10    ! [SQR.INI] 4=Arial,proportional
  Print 'Report Total:'  (20,4) Bold 
  Print 'Percentage of children without Education Detail:'  (99,4) Bold 
  Print '%'  (99,273) Bold 
  Print 'Number of children without Education Detail:'  (41,4) Bold 
  Print 'Number of children with Education Detail not updated for past 12 months:'  (57,4) Bold 
   Let #childCnt=#_cWODtl
 Print #childCnt (40,229) Edit 9999 Bold 
   Let #childcntWithDtl=#_cWithDtl
 Print #childcntWithDtl (56,359) Edit 9999 Bold 
   Let #percentNo=(#_cWODtl/(#_cTotalChild)) * 100
 Print #percentNo (99,245) Edit 9999 Bold 
   Let #cntTotalChild=#_cTotalChild
 Print #cntTotalChild (78,403) Edit 9999 Bold 
   Let #sTotal=#sTotal
 Print #sTotal (20,76) Edit 9999 Bold 
  Print 'Percentage of children with Education Detail not updated for past 12 months:'  (114,4) Bold 
   Let #percentNo=(#_cWithDtl/(#_cTotalChild)) * 100
 Print #percentNo (114,374) Edit 9999 Bold 
  Print '%'  (114,401) Bold 
  Print 'Total number of children in Foster Care eligible to have an Education Detail page:'  (78,4) Bold 
 End-If
 Next-Listing
! Do Calc-Percentage(#stgcnt, #_CNT_EDDTLYes, #_CNT_EDDTLNo, #PER_CNT_EDDTLYes, #PER_CNT_EDDTLNo)
! Do Calc_Percentage(#_cWODtl,#percentNo)
 Do Calc_Percentage1(#_cWODtl,#_cWithDtl,#_cTotalChild,#percentNo,#percentYes)

!  Place the closing tag(s) into the XML file
   Write 1 from '<output>'
   Write 1 from '</output>'
   Close 1
End-Procedure

begin-procedure DisplayResult
If #1ROW_COUNT= 0
 Let $textdisp='No results matching the report parameters are available'
end-if
Move $textdisp to $outText
end-procedure


Begin-Procedure Master_QueryCD_STAGE_REGION_BeforeProc101
If $regSelected = 'Y' or $cntySelected = 'Y' or ($unitSelected = 'Y'  and $regSelected = 'Y') or $cmSelected = 'Y'
    ! do nothing
 Else
 Next-Listing  Need=16
 Graphic (2,1,717) Horz-Line 22 
 Position (4,1)
  Alter-Printer Font=4 Point-Size=10    ! [SQR.INI] 4=Arial,proportional
 Print &Master_Query_STAGE00.CD_STAGE_REGION (16,48,4) Bold 
 Print 'Region:'  (16,3) Bold 
   Position (+12,)
 Next-Listing  Need=22
End-If
 Alter-Printer Font=4 Point-Size=10    ! [SQR.INI] 4=Arial,proportional
End-Procedure

Begin-Procedure Master_QueryCD_STAGE_REGION_AfterProc101
If $regSelected = 'Y' or $cntySelected = 'Y' or ($unitSelected = 'Y'  and $regSelected = 'Y') or $cmSelected = 'Y'
    ! do nothing
 Else
 Next-Listing  Need=17
 Graphic (2,1,717) Horz-Line 20 
 Position (4,1)
 Alter-Printer Font=4 Point-Size=10    ! [SQR.INI] 4=Arial,proportional
 Print 'Region Total:'  (17,3) Bold 
  If $regSelected = 'Y' or $cntySelected = 'Y' or ($unitSelected = 'Y'  and $regSelected = 'Y') or $cmSelected = 'Y'
    ! do nothing
 Else
 Let #regTotal=#regTotal
 Print #regTotal (17,75) Edit 9999 Bold 
 End-If
   Position (+12,)
 Next-Listing  Need=22
 Alter-Printer Font=4 Point-Size=10    ! [SQR.INI] 4=Arial,proportional
End-If
 Move 0 to #regTotal
End-Procedure

Begin-Procedure Master_QueryDECODE_BeforeProc102
If ($cntySelected = 'Y' and $unit_selected = 'Y' )  or $cntySelected = 'Y' or $cmSelected = 'Y'
    ! do nothing
 Else
 Next-Listing  Need=19
 Graphic (2,1,717) Horz-Line 17 
 Position (3,1)
  Alter-Printer Font=4 Point-Size=10    ! [SQR.INI] 4=Arial,proportional
 Print &Master_Query_DECODE (19,1,51) Bold 
   Position (+12,)
 Next-Listing  Need=22
End-If
 Alter-Printer Font=4 Point-Size=10    ! [SQR.INI] 4=Arial,proportional
End-Procedure

Begin-Procedure Master_QueryDECODE_AfterProc102
If ($cntySelected = 'Y' and $unit_selected = 'Y' )  or $cntySelected = 'Y' or $cmSelected = 'Y'
    ! do nothing
 Else
 Next-Listing  Need=17
 Graphic (1,1,717) Horz-Line 17 
 Position (2,1)
 Alter-Printer Font=4 Point-Size=10    ! [SQR.INI] 4=Arial,proportional
 Print 'County Total:'  (17,3) Bold 
  If ($cntySelected = 'Y' and $unit_selected = 'Y' )  or $cntySelected = 'Y' or $cmSelected = 'Y'
    ! do nothing
 Else
 Let #cntyTotal=#cntyTotal
 Print #cntyTotal (17,74) Edit 9999 Bold 
 End-If
   Position (+12,)
 Next-Listing  Need=22
 Alter-Printer Font=4 Point-Size=10    ! [SQR.INI] 4=Arial,proportional
End-If
 Move 0 to #cntyTotal
End-Procedure

Begin-Procedure Master_QueryID_UNIT_BeforeProc103
 If $unitSelected = 'Y' or $cmSelected = 'Y'
    ! do nothing
 Else
 Next-Listing  Need=18
 Graphic (3,1,717) Horz-Line 12 
 Position (4,1)
  Alter-Printer Font=4 Point-Size=10    ! [SQR.INI] 4=Arial,proportional
 Print &Master_Query_CAPS.UNIT.ID_UNIT (18,291) Edit 9999999999999999na Foreground=(255,255,255)
 Print 'Unit # and Supervisor:'  (17,3) Bold 
  Print &SupervisorNm (17,133,25) Bold 
  Print &Master_Query_NBR_UNIT (17,117,2) Bold 
   Position (+12,)
 Next-Listing  Need=22
 End-if
 Alter-Printer Font=4 Point-Size=10    ! [SQR.INI] 4=Arial,proportional
End-Procedure

Begin-Procedure Master_QueryID_UNIT_AfterProc103
 If $unitSelected = 'Y' or $cmSelected = 'Y'
    ! do nothing
 Else
 Next-Listing  Need=18
 Graphic (3,1,715) Horz-Line 12 
 Position (4,1)
 Alter-Printer Font=4 Point-Size=10    ! [SQR.INI] 4=Arial,proportional
 Print 'Unit Total:'  (18,5) Bold 
  If $unitSelected = 'Y' or $cmSelected = 'Y'
    ! do nothing
 Else
 Let #unitTotal2=#unitTotal
 Print #unitTotal2 (18,61) Edit 9999 Bold 
 End-If
   Position (+12,)
 Next-Listing  Need=22
 Alter-Printer Font=4 Point-Size=10    ! [SQR.INI] 4=Arial,proportional
 End-If
 Move 0 to #unitTotal
End-Procedure

Begin-Procedure Master_QueryID_PERSON_BeforeProc104
 If $cmSelected = 'Y'
    ! do nothing
 Else
 Next-Listing  Need=16
 Graphic (3,1,716) Horz-Line 10 
 Position (4,1)
  Alter-Printer Font=4 Point-Size=10    ! [SQR.INI] 4=Arial,proportional
 Print &CMID (16,129) Edit 9999999999na Bold 
 Print 'Case Manager ID / Name:'  (16,4) Bold 
  Print &CMName (16,189,25) Bold 
   Position (+12,)
 Next-Listing  Need=22
 End-If
 Alter-Printer Font=4 Point-Size=10    ! [SQR.INI] 4=Arial,proportional
End-Procedure

Begin-Procedure Master_QueryID_PERSON_AfterProc104
 Add #childcnt to #cmTotal2
 Add #childcnt to #unitTotal
 Add #childcnt to #cntyTotal
 Add #childcnt to #regTotal
 Add #childcnt to #sTotal
 Let #childcnt = #childcnt + 1
 If $cmSelected = 'Y'
    ! do nothing
 Else
 Next-Listing  Need=16
 Graphic (2,2,715) Horz-Line 10 
 Position (3,1)
 Alter-Printer Font=4 Point-Size=10    ! [SQR.INI] 4=Arial,proportional
 Print 'Casemanager Total:'  (16,4) Bold 
  If $cmSelected = 'Y'
    ! do nothing
 Else
 Let #MgrTotal=#cmTotal2
 Print #MgrTotal (16,109) Edit 9999 Bold 
 End-If
   Position (+12,)
 Next-Listing  Need=22
 Alter-Printer Font=4 Point-Size=10    ! [SQR.INI] 4=Arial,proportional
 End-If
 Move 0 to #childcnt
 Move 0 to #cmTotal2
End-Procedure

Begin-Procedure Master_QueryID_PERSON_AfterProc105
 Let #childcnt = #childcnt + 1
 Next-Listing  Need=13
 Alter-Printer Font=4 Point-Size=10    ! [SQR.INI] 4=Arial,proportional
 Print 'rrr'  (13,4) Foreground=(255,255,255)
   Position (+12,)
 Next-Listing  Need=22
 Alter-Printer Font=4 Point-Size=10    ! [SQR.INI] 4=Arial,proportional
End-Procedure

Begin-Procedure Grade_Query (#P1_ID_PERSON)
Begin-Select Loops=1
CAPS.CSCHGRAD.DECODE &_CurrGrade
(case when  EDUCATIONAL_HISTORY.CD_CURR_GRADE is null then   CSCHGRAD_2.DECODE  else   CSCHGRAD.DECODE end) &_currEnrollGr
From  CAPS.EDUCATIONAL_HISTORY, CAPS.CSCHGRAD
,      CAPS.CSCHGRAD CSCHGRAD_2
Where ID_PERSON = #P1_ID_PERSON
 And EDUCATIONAL_HISTORY.ID_EDHIST  = (select max(edh2.id_edhist) from educational_history edh2 where edh2.id_person = EDUCATIONAL_HISTORY.ID_PERSON)

 And EDUCATIONAL_HISTORY.CD_CURR_GRADE =  CSCHGRAD.CODE(+)
 And EDUCATIONAL_HISTORY.CD_EDHIST_ENROLL_GRADE =  CSCHGRAD_2.CODE(+)
End-Select
End-Procedure

Begin-Procedure CreateXML_ManifestFile
! Open the XML file.
 Let $_XML_Var='SQROutput.xml'
 Open $_XML_Var as 1 for-writing record=32767:vary
! Place the elements of the DTD.
 Let $preamble = '<?xml version="1.0" encoding="ISO-8859-1"?>'
 Write 1 from $preamble
End-Procedure

Begin-Procedure LoadLookupTables
   Load-Lookup
      Name=CountyLP
      Table=CAPS.CCOUNT
      Key=CODE
      Return_Value=DECODE
      Rows=65535
      Extent=65535
      Sort=SC
      Quiet

End-Procedure

Begin-Heading 60 
 do HeadingProcedure
End-Heading

Begin-Procedure HeadingProcedure
 If #page-count <= 1
  Position (1,1)
 Alter-Printer Font=4 Point-Size=10    ! [SQR.INI] 4=Arial,proportional
 Print $current-date (13,650) edit 'MM/DD/YYYY'
 Print-Image (1,1)
	Type=bmp-file
	Source='SHINES.bmp'
	Image-size=(102,73)
 Alter-Printer Font=4 Point-Size=14    ! [SQR.INI] 4=Arial,proportional
 Print 'Education Detail Report' (56,279,0) Bold 
 Alter-Printer Font=4 Point-Size=10    ! [SQR.INI] 4=Arial,proportional
 Print 'Produced On:' (13,585,0)
 Print 'Division of Family and Children Services' (16,274,0)
 Let $outText=$outText
 Print $outText (118,253,55)
 Let $headerDisp=$_headerDisp
 Print $headerDisp (76,324,12) Bold 
 Let $stageVarText='Stage Type: ' || $stageVarText
 Print $stageVarText (102,5,33) Bold 
 Let $unitVar='Unit #: ' || $unitVar
 Print $unitVar (119,5,15) Bold 
 Print 'wwwww' (164,1,5) Underline  Bold  Foreground=(255,255,255)
 Print 'Child Name' (164,6,0) Underline  Bold 
 Print 'DOB' (164,220,0) Underline  Bold 
 Print 'Last Updated' (164,555,10) Underline  Bold  Wrap 10 3 line-height=12 Keep-Top on=  
 Print 'Dt Stage Opened' (164,164,8) Underline  Bold  Wrap 8 2 line-height=12 Keep-Top on= 
 Print 'IEP' (164,617,0) Underline  Bold 
 Print 'HS GED' (164,638,0) Underline  Bold 
 Print 'Case ID' (164,119,0) Underline  Bold 
 Print 'Age' (164,275,0) Underline  Bold 
 Print 'School' (164,299,0) Underline  Bold 
 Print 'Curr/Enrll Grade' (164,395,10) Underline  Bold  Wrap 10 2 line-height=12 Keep-Top
 Print 'Edu Type' (164,464,7) Underline  Bold  Wrap 7 2 line-height=12 Keep-Top on= 
 Print 'Edu Program' (164,499,7) Underline  Bold  Wrap 7 2 line-height=12 Keep-Top on= 
 Print 'Post Sec.' (164,679,4) Underline  Bold  Wrap 4 5 line-height=12 Keep-Top
 Else   ! put a non combined page header
 Print 'wwwww' (29,1,5) Underline  Bold  Foreground=(255,255,255)
 Print 'Child Name' (29,6,0) Underline  Bold 
 Print 'DOB' (29,220,0) Underline  Bold 
 Print 'Last Updated' (29,555,10) Underline  Bold  Wrap 10 3 line-height=12 Keep-Top on=  
 Print 'Dt Stage Opened' (29,164,8) Underline  Bold  Wrap 8 2 line-height=12 Keep-Top on= 
 Print 'IEP' (29,617,0) Underline  Bold 
 Print 'HS GED' (29,638,0) Underline  Bold 
 Print 'Case ID' (29,119,0) Underline  Bold 
 Print 'Age' (29,275,0) Underline  Bold 
 Print 'School' (29,299,0) Underline  Bold 
 Print 'Curr/Enrll Grade' (29,395,10) Underline  Bold  Wrap 10 2 line-height=12 Keep-Top
 Print 'Edu Type' (29,464,7) Underline  Bold  Wrap 7 2 line-height=12 Keep-Top on= 
 Print 'Edu Program' (29,499,7) Underline  Bold  Wrap 7 2 line-height=12 Keep-Top on= 
 Print 'Post Sec.' (29,679,4) Underline  Bold  Wrap 4 5 line-height=12 Keep-Top
 End-If
 Alter-Printer Font=901 Point-Size=10
End-Procedure
Begin-Footing 36 
 Alter-Printer Font=4 Point-Size=10    ! [SQR.INI] 4=Arial,proportional
 Page-Number (19,652) '' ' of '
 Last-Page (19,681) 
 Alter-Printer Font=901 Point-Size=10
End-Footing

